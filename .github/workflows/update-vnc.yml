name: VNC Screenshot Bot

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  screenshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install VNC client and Python
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install vncdotool

      - name: Take Screenshot for G11
        continue-on-error: true
        env:
          VNC_PASSWORD: ${{ secrets.G11_VNC_PASSWORD }}
          VNC_SERVER: ${{ secrets.G11_VNC_SERVER }}
        run: |
          vncdotool -s "$VNC_SERVER" -p "$VNC_PASSWORD" capture g11_screenshot.png
      - name: Take Screenshot for G12
        continue-on-error: true
        env:
          VNC_PASSWORD: ${{ secrets.G12_VNC_PASSWORD }}
          VNC_SERVER: ${{ secrets.G12_VNC_SERVER }}
        run: |
          vncdotool -s "$VNC_SERVER" -p "$VNC_PASSWORD" capture g12_screenshot.png
      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -f g11_screenshot.png ]; then
            git add g11_screenshot.png
          else
            git rm --cached g11_screenshot.png --ignore-unmatch
          fi
          
          if [ -f g12_screenshot.png ]; then
            git add g12_screenshot.png
          else
            git rm --cached g12_screenshot.png --ignore-unmatch
          fi

          git commit -m "Update VNC screenshot: $(date)" || exit 0
          git push
